Potential issues in being able to summarise estimates hierarchically


Say we have example table 'df'. 
Df contains a treatment variable, x1, x2 and y (the outcomes)
y is generated by the equation:
	y = (t*1) + (x1*1.5) + (x2*.8) + (x1 * t * 1.5)
	there is 1 interaction term between treatment and x1

       t    x1    x2     y
   <dbl> <dbl> <dbl> <dbl>
 1     1     1     1   4.8
 2     0     1     2   3.1
 3     1     1     3   6.4
 4     0     3     1   5.3
 5     1     3     2  11.6
 6     0     3     3   6.9
 7     1     3     1  10.8
 8     0     3     2   6.1
 9     1     3     3  12.4
10     0     3     1   5.3

The primary objective is to get the conditional ATE (for simplicity rather than ATT)
for each of 
x1 	x2 
1	1
1	2
1	3
3	1
3	2
3	3

this is simply done by training a lm
	m1 = lm("y ~ x1 + x2 + t + x1*t", data=x)
which for simplicity is correctly specified

then taking the the differnce in countterfactual predictions
	c1 = subset(x, x1==1 & x2==1) %>% mutate(t = 1) %>% rbind(subset(x, x1==1 & x2==1) %>% mutate(t = 0))
	mean((subset(c1, t==1) - subset(c1, t==0))$pred)

x1 	x2 	ate
1	1	2.5
1	2	2.5
1	3	2.5
3	1	5.5			note the elevation because of the x1 interaction
3	2	5.5
3	3	5.5

Alternative to the 'c1=subset(...)' approach we could have generate a combinatorial grid and derive marginal expectations.
In this case both results would be equivalent, but that isn't always true as shown below.

Now we want to get ATE of x2 == 1. 

in a simple approach we could just average the ATE over the x2 condition from above
	mean(2.5, 5.5) = 4

however this in my mind doesnt respect the sample distribution.
Specifically we see that w/in the subset x2 == 1, X1 is not equally distributed
      t    x1    x2     y
  <dbl> <dbl> <dbl> <dbl>
1     1     1     1   4.8
2     0     3     1   5.3
3     1     3     1  10.8
4     0     3     1   5.3

so to derive (ate|x2=1) we woud actually use a grid like below
# A tibble: 8 Ã— 4
      t    x1    x2     y
  <dbl> <dbl> <dbl> <dbl>
1     1     1     1   4.8
2     1     3     1   5.3
3     1     3     1  10.8
4     1     3     1   5.3
5     0     1     1   4.8
6     0     3     1   5.3
7     0     3     1  10.8
8     0     3     1   5.3

and taking the treatment effect

      t    x1    x2     y
  <dbl> <dbl> <dbl> <dbl> 	te
1     1     1     1   4.8	2.5
2     0     3     1   5.3	5.5		note again that the x1 interaction w/ t is driving the differnce
3     1     3     1  10.8	5.5
4     0     3     1   5.3	5.5

and then mean to get ate|x2==1 we get
	4.75

this should be equivalent to the weighted mean of the distinct ates derived earlier.


#################
If my logic is not incorrect, then I think we may have some issues in 
creating "drill-down" tables.

I think if these set of possible distinct categories is large the 
computed table becomes large.
for example 15 categories 
the N choose K would be about 32767 rows.

with the larger issue being that the predictions would need to 
be generated from a series of tables.

would may be easier to derive samples weights for each conditional
and then compute weighted averages on the fly.

